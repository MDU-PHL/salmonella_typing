---
title: "MMS136 Limit of detection report"
author:
    - "MDU PHL"
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
   rmd: "report.Rmd"
output:
  pdf_document:
  highlight: tango
  number_sections: no
  theme: default
  toc: yes
  toc_depth: 3
editor_options: 
  chunk_output_type: console
---

```{r, load_libs}
library(tidyverse)
library(readxl)
library(glue)
library(ggplot2)
library(kableExtra)
```

```{r, functions}
check_positive_control <- function(tab) {
  stat <- tab %>%
      filter(SEQID == '9999-99999-1') %>%
      pull(STATUS)
  return(stat == 'PASS')
}

load_data <- function(skobj, asm){
  sistr_res <- skobj@input[[glue('sistr_res_{asm}')]]
  sistr_metad <- skobj@input[[glue('sistr_metat_{asm}')]]
  res <- read_xlsx(sistr_res, sheet='ALL')
  metad <- read_tsv(sistr_metad)
  
}
```


```{r, load_data}
base_dir = '~/Downloads/'
sistr_spades = file.path(base_dir, 'SISTR_LIMS_spades.xlsx')
exp_spades = file.path(base_dir, 'sistr_input_spades.txt')
res <- read_xlsx(sistr_spades, sheet='ALL')
metad <- read_tsv(exp_spades)
res_raw <- res %>%
  select(-ID) %>%
  left_join(metad, c("SEQID" = "SEQID")) 

res_clean <- res_raw %>%
  select(ID, SEQID, assembler, depth, rep, STATUS, num_seqs, sum_len, min_len, max_len) %>%
  mutate(POS_CONTROL_PASS = check_positive_control(.)) %>%
  filter(SEQID != '9999-99999-1') %>%
  mutate(OUTCOME = if_else(STATUS == 'PASS', 1, 0))

res_clean %>%
  group_by(depth) %>%
  summarise(TOTAL_PASS = sum(OUTCOME),
            PROP_PASS = sum(OUTCOME)/n()) %>%
  ggplot(aes(x = depth, y = PROP_PASS)) +
    geom_point() +
    xlab("Depth") +
    ylab("Proportion Passed")

ggplot(res_clean, aes(x = max_len, y = OUTCOME)) +
  geom_jitter()
```



## R Markdown

This is an R Markdown document.

Test include from snakemake `r snakemake@input`.

