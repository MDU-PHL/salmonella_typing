---
title: "MMS136 Limit of detection report"
author:
    - "MDU PHL"
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
   rmd: "report.Rmd"
output:
  pdf_document:
  highlight: tango
  number_sections: no
  theme: default
  toc: yes
  toc_depth: 3
editor_options: 
  chunk_output_type: console
---

```{r, load_libs}
library(tidyverse)
library(readxl)
library(glue)
library(ggplot2)
library(kableExtra)
testing = TRUE
asms <- c('spades', 'skesa', 'shovill')
```

```{r, functions}
check_positive_control <- function(tab) {
  stat <- tab %>%
      filter(SEQID == '9999-99999-1') %>%
      pull(STATUS)
  return(stat == 'PASS')
}

get_file <- function(pattern, file_list) {
  ix <- which(grepl(pattern = pattern, file_list))
  return(file_list[ix])
}

load_data <- function(skobj, asm){
  sistr_res <- get_file(asm, skobj@input[['sistr_res']])
  sistr_metad <- get_file(asm, skobj@input[['sistr_metad']])
  res <- read_xlsx(sistr_res, sheet='ALL')
  metad <- read_tsv(sistr_metad)
  
  res_raw <- res %>%
    select(-ID) %>%
    left_join(metad, c("SEQID" = "SEQID"))

  res_clean <- res_raw %>%
    select(ID, SEQID, assembler, depth, rep, STATUS, num_seqs, sum_len, min_len, max_len, N50) %>%
    mutate(POS_CONTROL_PASS = check_positive_control(.)) %>%
    filter(SEQID != '9999-99999-1') %>%
    mutate(OUTCOME = if_else(STATUS == 'PASS', 1, 0))
  
  return(list(raw = res_raw,
              clean = res_clean))
}

if(testing) {
  base_dir = '~/Downloads'
  setClass('sk', representation(input = 'list'))
  skobj <- new(Class = 'sk', input = list(
    'sistr_res' = sapply(asms, function(asm) file.path(base_dir, glue('SISTR_LIMS_{asm}.xlsx'))),
    'sistr_metad' = sapply(asms, function(asm) file.path(base_dir, glue('sistr_input_{asm}.txt')))
  ))
}
```


```{r, load_data}

dat <- lapply(asms, function(asm) load_data(skobj, asm))

clean_dat <- bind_rows(lapply(dat, function(d) d$clean))

clean_dat %>%
  group_by(assembler, ID, depth) %>%
  summarise(TOTAL_PASS = sum(OUTCOME),
            PROP_PASS = sum(OUTCOME)/n()) %>%
  ggplot(aes(x = depth, y = PROP_PASS)) +
    geom_point() +
    xlab("Depth") +
    ylab("Proportion Passed") +
    facet_grid(ID~assembler)

clean_dat %>%
  group_by(depth, ID, assembler) %>%
  summarise(TOTAL_PASS = sum(OUTCOME),
            PROP_PASS = sum(OUTCOME)/n())

clean_dat %>%
  filter(ID == "SRR7284860") %>%
  ggplot(aes(x = depth, N50, col = assembler)) +
  geom_point()

ggplot(clean_dat, aes(x = max_len, y = OUTCOME)) +
  geom_jitter()
```



## R Markdown

This is an R Markdown document.

Test include from snakemake `r snakemake@input`.

